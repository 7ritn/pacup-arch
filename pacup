#!/bin/bash

function usage() {
  cat <<EOM
Usage: $(basename "$0") [OPTION]...
    -p          Run Pacman only
    -y          Skip typing 'y'
    -h          Show help
EOM
}

while (($#>0)); do
  case $1 in
    p|-p|--pacman)
      PACUP_MOD="pacman"
      ;;
    y|-y|--yes)
      PACUP_YES="yes|"
      ;;
    h|-h|--help)
      usage
      exit 0
      ;;
    *)
      usage
      exit 1
      ;;
  esac
  shift
done

function PACUP_SYS() {
  if [ $(command -v snap) ]; then
    echo -e "\nRunning sudo snap refresh..."
    sudo snap refresh
  fi
  if [ $(command -v flatpak) ]; then
    echo -e "\nRunning $PACUP_YESsudo flatpak update..."
    sudo flatpak update$PACUP_YES
}

function PACUP_PACMAN() {
  echo -e "\nUpdating Pacman packages..."
  $PACUP_YES sudo pacman -Syu
  echo -e "\nRemoving no-needed Pacman packages..."
  $PACUP_YES sudo pacman -Rnsc $(pacman -Qtdq)  
}

if [ "$PACUP_MOD" == "pacman" ]; then
   PACUP_PACMAN
  if [ $? != 0 ]; then
    echo -e "\nPacman command requires root privileges.\nPlease try again.\n"
    PACUP_PACMAN
  fi
  exit 0
fi

if [ $(command -v flatpak) ]; then
  echo -e "\nRunning $PACUP_YESflatpak update..."
  $PACUP_YESflatpak update
fi
PACUP_SYS
if [ $? != 0 ]; then
  echo -e "\nRequesting root privileges.\nPlease try again.\n"
  PACUP_SYS
  if [ $? != 0 ]; then
    echo -e "\nExecution terminated because privilege elevation failed."
    exit 1
  fi
fi
PACUP_PACMAN
#AUR
exit 0
